# 前言

实验环境

```
OS: Fedora Silverblue
Editor: Pycharm community(flatpak)
Pytorch: cuda=12.1, python=3.12
```

包依赖

* matplotlib==3.8.4
* numpy==1.26.4
* Pillow==10.4.0
* tqdm==4.66.4
* wandb==0.17.5

# 初次运行

默认数据集[Carvana Image Masking Challenge](https://www.kaggle.com/c/carvana-image-masking-challenge/data)

wandb记录了[本次运行情况](https://wandb.ai/anony-mouse-721423276759826725/U-Net/runs/e4bc00ym/overview)

    INFO: Starting training:
    Epochs:          3
    Batch size:      2
    Learning rate:   1e-05
    Training size:   4580
    Validation size: 508
    Checkpoints:     True
    Device:          cuda
    Images scaling:  0.5
    Mixed Precision: False

运行正常，一段时间后手动终止。

# Cellpose数据集

显然会报错，疑似文件命名问题。

Function Call Chain:

1. `train.py` calls `train_model`, which creates a `CarvanaDataset` or `BasicDataset` instance.
2. The `CarvanaDataset` or `BasicDataset` initializer calls the parent class (`BasicDataset`) initializer.
3. The parent class initializer calls `unique_mask_values`.
4. The error occurs in `unique_mask_values`:
   ```python
   mask_file = list(mask_dir.glob(idx + mask_suffix + '.*'))[0]
   ```

debug发现 **mask_suffix = '_mask'** ，而cellpose数据集的命名是 **'_masks'**。

找到相关函数

```python
class CarvanaDataset(BasicDataset):
    def __init__(self, images_dir, mask_dir, scale=1):
        super().__init__(images_dir, mask_dir, scale, mask_suffix='_mask')
```

更改后依然报错，排查后发现原图命名错误导致无法正常匹配。去掉原图的命名后缀"_img"。

数据集能够正常加载，出现新的报错如下：


```
RuntimeError: stack expects each tensor to be equal size, but got [3, 102, 110] at entry 0 and [3, 256, 256] at entry 1
```

第二天重新运行准备看看Traceback，出现新的报错：

```
RuntimeError: CUDA error: device-side assert triggered
CUDA kernel errors might be asynchronously reported at some other API call, so the stacktrace below might be incorrect.
For debugging consider passing CUDA_LAUNCH_BLOCKING=1.
Compile with `TORCH_USE_CUDA_DSA` to enable device-side assertions.
```


# 部分除错记录

1. 环境指定包版本与Pytorch冲突，取消对应包的版本限制。
2. Kaggle下载数据，出现403 Forbidden。去对应网站同意规则。
3. 实验最初使用VSCode，调试不太方便遂改用PyCharm。
4. 关闭wandb功能。
